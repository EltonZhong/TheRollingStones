---
title: 'ç¼–è¯‘ä¹‹åŽ--Kotlin åç¨‹'
cover: imgs/lips.png
tags:
  - Code
categories:
  - code
desc: "Kotlinåç¨‹åœ¨è·¨å¹³å°é¡¹ç›®çš„ä½¿ç”¨"
date: 2018-12-16 21:37:45
---

# Kotlin åç¨‹
æœ¬æ–‡åªæ˜¯æµ…æž Kotlin åç¨‹åœ¨å„å¹³å°çš„å®žçŽ°, ä»¥åŠè·¨å¹³å°å…¼å®¹æ–¹æ¡ˆã€‚ å¦‚æžœè¦çœ‹Kotlinåç¨‹apiçš„ç”¨æ³•ï¼Œè¯·ç§»æ­¥[æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« ](https://therollingstones.cn/2018/12/25/code/kotlin/KotlinCoroutine/)

è¨€å½’æ­£ä¼ , æˆ‘ä»¬èŠèŠ"åç¨‹".

***å¦‚æžœæœ‰è®²çš„ä¸å¥½çš„åœ°æ–¹ï¼Œ æ¬¢è¿Žåœ¨ä¸‹æ–¹è¯„è®º***

## åç¨‹ä»‹ç»
é¦–å…ˆï¼Œ ä»€ä¹ˆæ˜¯åç¨‹ï¼Ÿ
>æœ‰äººè¯´åç¨‹æ‹¥æœ‰è‡ªå·±çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆçš„è½»é‡çº§æ‰§è¡Œå•å…ƒï¼Œ å¯ä»¥åœ¨æŽ§åˆ¶æ‰§è¡Œä¸Šä¸‹æ–‡çš„åˆ‡æ¢ã€‚

>ç†Ÿæ‚‰Javascriptç”Ÿæˆå™¨çš„äººå¯èƒ½ä¼šè¯´ï¼Œåç¨‹å°±æ˜¯å›žè°ƒçš„è¯­æ³•ç³–ï¼Œæœ¬è´¨æ ¹æœ¬ä¸å…³æ–¹æ³•æ ˆä¸Šä¸‹æ–‡åˆ‡æ¢å•¥äº‹ã€‚

åˆ°åº•è°è¯´çš„æ˜¯å¯¹çš„ï¼Ÿ
åˆ«ç€æ€¥ï¼Œ çœ‹çœ‹ç»´åŸºç™¾ç§‘æ˜¯æ€Žä¹ˆè¯´çš„ï¼š

æˆ‘ä»¬å…ˆçœ‹çœ‹ä¸‹é¢è¿™æ®µæè¿°:
>Coroutines are computer-program components that generalize subroutines for non-preemptive multitasking, by allowing multiple entry points for suspending and resuming execution at certain locations

åç¨‹å°±æ˜¯å¯ä»¥ç”ŸæˆéžæŠ¢å å¼å­ç¨‹åºçš„è®¡ç®—æœºç¨‹åºï¼Œ å¯ä»¥å…è®¸ç¨‹åºæœ‰å¤šä¸ªç‰¹å®šçš„åœ°æ–¹å¯ä»¥æŒ‚èµ·æˆ–è€…æ¢å¤æ‰§è¡Œã€‚

## Kotlin åç¨‹åœ¨å„å¹³å°ç¼–è¯‘æˆä»€ä¹ˆï¼Ÿ

>ç†Ÿæ‚‰Javascriptç”Ÿæˆå™¨çš„äººå¯èƒ½ä¼šè¯´ï¼Œ åç¨‹å°±æ˜¯å›žè°ƒçš„è¯­æ³•ç³–ï¼Œ æœ¬è´¨æ ¹æœ¬ä¸å…³æ–¹æ³•æ ˆä¸Šä¸‹æ–‡åˆ‡æ¢å•¥äº‹ã€‚

åœ¨Kotlin åç¨‹ä¹‹å‰ï¼Œ æˆ‘ä»¬è®²è®²å…³äºŽJsçš„æ•…äº‹ã€‚
>å¤§å®¶éƒ½çŸ¥é“Jsæœ‰è¯¸å¤šç‰ˆæœ¬ï¼Œ æˆ‘ä»¬ç»å¸¸ç”¨ç€Es6ã€7ã€8çš„è¯­æ³•, ä½¿ç”¨Babelå°†å®ƒä»¬ç¼–è¯‘æˆä½Žç‰ˆæœ¬ï¼Œ å†åœ¨æµè§ˆå™¨æˆ–è€…ä½Žç‰ˆæœ¬nodeæ‰§è¡Œã€‚ è¿™é‡Œæˆ‘ä»¬å•çº¯å¯¹Node.jsè¿›è¡Œè®¨è®ºã€‚

>ä½Žç‰ˆæœ¬çš„Nodeæœ‰åç¨‹å—ï¼Ÿ ä½ å¯ä»¥è¯´æ²¡æœ‰ã€‚å®žçŽ° coroutine çš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ ES6 çš„ generatorï¼ŒES8(`ä½ æ²¡æœ‰çœ‹é”™, ä¸æ˜¯ES7`) çš„ async/awaitã€‚åœ¨ä½Žç‰ˆæœ¬çš„Nodeä¸­ï¼Œ è‡ªç„¶æ˜¯æ²¡æœ‰åç¨‹çš„ï¼Œ é«˜çº§çš„ç”Ÿæˆå™¨å‡½æ•°å°†ä¼šç¼–è¯‘æˆæ™®é€šçš„Jså›žè°ƒã€çŠ¶æ€æœºä»£ç (`æˆ‘ä»¬åŽé¢ä¼šè®²åˆ°`)ï¼Œ ä½†æ˜¯åœ¨Node.js 8ä¹‹åŽçš„ç‰ˆæœ¬ï¼Œ node.jsåŽŸç”Ÿæ”¯æŒäº†åç¨‹ï¼Œ å®žçŽ°äº†å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆçš„åˆ‡æ¢ã€‚

>æ‰€ä»¥ï¼Œ æˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥è¯´ä¸€æ®µé«˜ç‰ˆæœ¬Jsä»£ç å¦‚æžœç»è¿‡ç¼–è¯‘æˆä½Žç‰ˆæœ¬ä»£ç åŽï¼Œ å°±ä¸åœ¨æ‹¥æœ‰åç¨‹äº†å‘¢ï¼Ÿ
> è¿™ä¹ˆè¯´æ˜¯ä¸å…¬å¹³çš„, å¦‚æžœè¿™ä¹ˆè¯´çš„è¯ï¼Œ é‚£æœ¬æ–‡å°±è¯¥æ¢æ ‡é¢˜äº†ï¼Œ Kotlinå°±æ²¡æœ‰åç¨‹äº†
>>`ä¸Šå±‚ä¸åº”è¯¥å…³å¿ƒä¸‹å±‚çš„å…·ä½“å®žçŽ°ï¼Œè€Œåªåº”è¯¥å…³å¿ƒä¸‹å±‚æä¾›çš„æŽ¥å£`


å¤§å®¶éƒ½çŸ¥é“ï¼Œ Jvmä¹Ÿæ˜¯æ²¡æœ‰åŽŸç”Ÿåç¨‹çš„ï¼Œå¤§éƒ¨åˆ†å¹³å°ï¼Œ åŒ…æ‹¬Kotlin-jsç¼–è¯‘åŽçš„es5 jsä»£ç ï¼Œ ä¹Ÿå¹¶æ²¡æœ‰å…³äºŽåç¨‹çš„åŽŸç”Ÿå®žçŽ°, (æˆ–è€…è¯´æ²¡æœ‰ç”¨åˆ°)ã€‚ é‚£ä¹ˆæŠŠåç¨‹çœ‹åšé‡è¦ç‰¹æ€§çš„Kotlinï¼Œ ç¼–è¯‘åŽæ˜¯æ€Žä¹ˆæ ·çš„å‘¢ï¼Ÿ
`Talk is cheap, show me your code.`
>è®©æˆ‘ä»¬çœ‹çœ‹ä¸‹é¢è¿™æ®µ(js å’Œ kotlin æ··å†™çš„)ä¼ªä»£ç 

```js
 suspend function postItems(item) {
     let tk = getToken(item)
     let post = doPost(tk)
     return post
 }

 interface StateMachine {
     status: number,
     item: Any,
     continuation: Continuation
 }

 function postI(item, sm: Continuation) {
     if (!sm instanceof StateMachine) {
         sm = {
             status: 0,
             item: null,
             continuation: sm
         }
     }

     switch sm.status:
         case 1:
             sm.status += 1;
             getToken(item, (tk) => {
                 sm.item = tk;
                 postI(null, sm)
             })
         case 2:
             sm.status += 1;
             doPost(sm.item, (post) => {
                 sm.item = post;
                 postI(null, sm)
             })
         case 3:
             sm.continuation.resume(sm.item)
             return
 }
```

**ç®€æžï¼š**
> postItems æ˜¯ä¸€ä¸ªkotlinçš„suspendæ–¹æ³•ï¼Œ ä»–å…ˆé€šè¿‡httpè¯·æ±‚æ‹¿åˆ°tokenï¼Œ å†é€šè¿‡tokenå‘èµ·ä¸€ä¸ªhttp post è¯·æ±‚ï¼Œ å°†è¿”å›žçš„å¯¹è±¡ è¿”å›žç»™è°ƒç”¨è€…ã€‚ 

>å¯¹åº”ç¼–è¯‘åŽçš„å®žçŽ°å°±æˆäº†postI,ä¸€ä¸ªæ™®é€šçš„æ–¹æ³•,æŽ¥å—ä¸€ä¸ªContinuationç±»åž‹å¯¹è±¡çš„æ–¹æ³•ã€‚è€Œè¿™ä¸ª Continuation,å¯ä»¥è¿‘ä¼¼çœ‹åšä¸€ä¸ªå›žè°ƒå‡½æ•°, ä¹Ÿå°±æ˜¯è¯´, åœ¨jvmè¿™è¾¹, ä½ çš„suspend function, æœ€ç»ˆå˜æˆäº†æŽ¥å—ä¸€ä¸ªå›žè°ƒå‡½æ•°ä¸ºå‚æ•°çš„æ™®é€šæ–¹æ³•, è€Œä¸”åœ¨å…¶å®ƒå¹³å°ä¹Ÿå¤§æŠµç±»ä¼¼ã€‚

>é‚£ä¹ˆsuspend functioné‡Œé¢çš„suspend functionè°ƒç”¨æ˜¯æ€Žä¹ˆè°ƒçš„å‘¢ï¼Ÿçœ‹ä¸Šé¢çš„ä¼ªä»£ç ï¼Œä½ å¤§æ¦‚å¯ä»¥çŸ¥é“ï¼š é€šè¿‡å›žè°ƒ, åœ¨getTokençš„å›žè°ƒé‡Œé¢ç»§ç»­è°ƒç”¨postItemsæ–¹æ³•ï¼Œä½†æ˜¯çŠ¶æ€å·²ç»æ”¹å˜ï¼Œåˆ™å¯ä»¥æ‰§è¡Œåˆ°ä¸‹ä¸€ä¸ªsuspendæŒ‚èµ·ç‚¹ï¼Œä»¥æ­¤ç±»æŽ¨,é€šè¿‡è¿™ä¸ªçŠ¶æ€æœºå®žçŽ°äº†åŽŸæ¥kotlin suspend æ–¹æ³•çš„`æŒ‚èµ·ä¸Žæ¢å¤`ã€‚

## Kotlin è·¨å¹³å°å®žçŽ°
è™½ç„¶Kotlin ç¼–è¯‘åŽçš„æ™®é€šæ–¹æ³•æä¾›äº†å›žè°ƒçš„åº”ç”¨ï¼Œ ä½†æ˜¯æ­£å¦‚å®˜æ–¹æ–‡æ¡£ä¸­æ‰€è¯´ï¼Œ ä½ æ°¸è¿œä¸è¦å°è¯•åœ¨å„ä¸ªå¹³å°å®žçŽ°è¿™äº›å›žè°ƒï¼Œ é™¤éžä½ æ˜¯ä¸ª `"coroutine master"`, å®žçŽ°contextç­‰éƒ½æ˜¯æœ‰å‘çš„ã€‚

### Kotlin åç¨‹ node.js
kotlin.coroutines æœ‰ä¸ªä¸“é—¨çš„ promise åº“ï¼Œ æ‰€ä»¥å¦‚æžœä½ è¦æš´éœ²ä¸€ä¸ªapiç»™å¤–é¢çš„jsåº“åŽ»è°ƒç”¨ï¼Œ ä½ å¯ä»¥è¿™ä¹ˆå†™ï¼š 
```kotlin
suspend fun helloWorld() {
  delay(1000)
  return "1212"
}

fun theApiYouWantToExposeAndUsedInOtherJsModules() {
  Globalscope.promise {
    helloworld()
  }
}
```

### Kotlin åç¨‹ jvm
Jvm æœ‰runblocking çš„apié˜»å¡žå½“å‰çº¿ç¨‹æ‰§è¡Œï¼Œ è¿™ä¸ªæ˜¯ä¸€ä¸ªä¼˜ç‚¹ï¼Œå› ä¸ºåœ¨node.jså•çº¿ç¨‹é‡Œé¢ä½ æ²¡åŠžæ³•runblocking.
 æ‰€ä»¥ä½ å¯ä»¥æš´éœ²è¿™æ ·çš„api: 
```kotlin
suspend fun helloWorld() {
  delay(1000)
  return "1212"
}

fun theApiYouWantToExposeAndUsedInOtherJvmProgram() = runBlocking {
    helloworld()
  }
}
```
å½“ç„¶ä¸ºäº†æ€§èƒ½æ›´æŽ¨èçš„æ–¹å¼æ˜¯åˆ©ç”¨jvm ç‹¬æœ‰future api è¿”å›žä¸€ä¸ªFuture å¯¹è±¡:
```kotlin
fun theApiYouWantToExposeAndUsedInOtherJvmProgram() = future {
    helloworld()
  }
}
```

### Kotlin åç¨‹ native

native ä¹Ÿæœ‰runblocking, ä¸è¿‡å¥½åƒåœ¨swift é‡Œé¢æœ‰ä¸ªå¤©å‘ã€‚æˆ‘å¯¹swiftä¸æ˜¯å¾ˆäº†è§£ï¼Œ è§£å†³æ–¹æ¡ˆç»™ä½ æ‰”è¿™äº†ï¼š https://github.com/ktorio/ktor/issues/678

>å¦‚æžœæœ‰é—®é¢˜æˆ–è€…è°¬è¯¯ï¼Œ æ¬¢è¿Žåœ¨è¯„è®ºæŒ‡å‡ºã€‚